package com.xoab.imageObjectDetection.controller;

import com.xoab.imageObjectDetection.dto.responseDTOs.ImageDataDTO;
import com.xoab.imageObjectDetection.dto.responseDTOs.ImageResponseDTO;
import com.xoab.imageObjectDetection.service.ImageService;
import com.xoab.imageObjectDetection.dto.ImageRequestDTO;
import jakarta.validation.Valid;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;

@RestController
@RequestMapping("/images")
@Slf4j
@CrossOrigin(origins = "*", methods = {RequestMethod.OPTIONS, RequestMethod.GET, RequestMethod.POST, RequestMethod.PUT, RequestMethod.DELETE}, allowedHeaders = "*")
public class ImageController {

    @Autowired
    ImageService imageService;

    /**
     * Returns a JSON response containing all image metadata, or, if 'objects' are specified, a response body containing
     * only images that have the detected objects specified in the query
     * parameter
     * @param objects
     * @return
     */
    @GetMapping
    public ResponseEntity getImages(@RequestParam(required = false) String objects,
                                    @RequestParam(required = false) String url){
        if (objects != null) {
            String[] separateObjects = objects.split(",");
            return imageService.getMatchingImages(separateObjects);
        } else if (url != null) {
            return imageService.getImage(url);
        } else {
            return imageService.getAllImageMetadata();
        }
    }

    /**
     * Returns a JSON response containing image metadata for the specified image
     * @param imageId
     * @return
     */
    @GetMapping("/{imageId}")
    public ResponseEntity getImageMetadata(@PathVariable Integer imageId){
        return imageService.getImageMetadata(imageId);
    }

    /**
     * Accepts a JSON request body including an image file OR url, an optional label for the image, and an optional
     * field to enable object detection.
     *
     * Returns a JSON response body including the image data, its label (autogenerated if not provided), database ID,
     * and any objects detected (IF object detection was enabled)
     *
     * @param imageRequestDTO
     * @return
     */
    @PostMapping
    public ResponseEntity addImage(@RequestBody @Valid ImageRequestDTO imageRequestDTO){
        // Make sure the file can be downloaded first
        try {
            String localFilePath = imageService.downloadFile(imageRequestDTO);

            ImageDataDTO imageDataDTO = imageService.addImage(imageRequestDTO, localFilePath);

            if (imageDataDTO != null) {
                return ResponseEntity.ok(new ImageResponseDTO(imageDataDTO));
            } else {
                return ResponseEntity.internalServerError().build();
            }

        } catch (IOException e) {
            log.error("Unable to download file", e);
            return ResponseEntity.unprocessableEntity().build();
        }
    }
}
